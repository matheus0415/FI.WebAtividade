
<div class="modal fade" id="modalBeneficiario" tabindex="-1" role="dialog" aria-labelledby="modalBeneficiarioLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="modalBeneficiarioLabel">Benefici&aacute;rios</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="modalCPFBeneficiario">CPF:</label>
                            <input type="text" class="form-control" id="modalCPFBeneficiario" placeholder="Ex.: 010.011.111-00" maxlength="14">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="modalNomeBeneficiario">Nome:</label>
                            <input type="text" class="form-control" id="modalNomeBeneficiario" placeholder="Ex.: Maria" maxlength="100">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-success btn-sm" id="btnIncluirBeneficiario">Incluir</button>
                                <button type="button" class="btn btn-default btn-sm" id="btnCancelarBeneficiario" style="display: none; margin-left: 5px;">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>CPF</th>
                                <th>Nome</th>
                                <th>A&ccedil;&otilde;es</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBeneficiarios">
                        </tbody>
                    </table>
                </div>

                <div id="msgSemBeneficiarios" class="text-center text-muted" style="padding: 20px;">
                    <i class="glyphicon glyphicon-info-sign"></i> Nenhum benefici&aacute;rio cadastrado
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var contadorBeneficiarios = 0;
    var beneficiarios = [];

    function mascaraCPFBeneficiario(cpf) {
        cpf = cpf.replace(/\D/g, "");
        cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
        cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        return cpf;
    }

    function incluirBeneficiario() {
        var cpfInput = document.getElementById('modalCPFBeneficiario');
        var nomeInput = document.getElementById('modalNomeBeneficiario');
        
        var cpf = cpfInput ? cpfInput.value.trim() : '';
        var nome = nomeInput ? nomeInput.value.trim() : '';
        
        if (!cpf) {
            alert('Por favor, informe o CPF do beneficiário.');
            if (cpfInput) cpfInput.focus();
            return;
        }

        if (!nome) {
            alert('Por favor, informe o nome do beneficiário.');
            if (nomeInput) nomeInput.focus();
            return;
        }
        
        var cpfLimpo = cpf.replace(/\D/g, "");
        if (cpfLimpo.length !== 11) {
            alert('Por favor, informe um CPF válido com 11 dígitos.');
            if (cpfInput) cpfInput.focus();
            return;
        }
        
        var btnIncluir = document.getElementById('btnIncluirBeneficiario');
        var editingId = btnIncluir ? btnIncluir.getAttribute('data-editing-id') : null;
        
        var beneficiario = {
            id: editingId ? parseInt(editingId) : ++contadorBeneficiarios,
            cpf: cpf,
            cpfLimpo: cpfLimpo,
            nome: nome
        };
        
        if (editingId) {
            var index = beneficiarios.findIndex(b => b.id === parseInt(editingId));
            if (index !== -1) {
                beneficiarios[index] = beneficiario;
            } else {
                beneficiarios.push(beneficiario);
            }
        } else {
            
            beneficiarios.push(beneficiario);
        }
        
        window.beneficiarios = beneficiarios;
        atualizarTabelaBeneficiarios();
        limparFormularioBeneficiario();
    }

    function atualizarTabelaBeneficiarios() {
        var tbody = document.getElementById('tabelaBeneficiarios');
        var msgSemBeneficiarios = document.getElementById('msgSemBeneficiarios');
        
        if (!tbody) {
            return;
        }
        
        tbody.innerHTML = '';
        
        if (beneficiarios.length === 0) {
            if (msgSemBeneficiarios) {
                msgSemBeneficiarios.style.display = 'block';
            }
        } else {
            if (msgSemBeneficiarios) {
                msgSemBeneficiarios.style.display = 'none';
            }
            
            for (var i = 0; i < beneficiarios.length; i++) {
                var beneficiario = beneficiarios[i];
                var cpfFormatado = beneficiario.cpf;
                
                var linha = document.createElement('tr');
                linha.id = 'linhaBeneficiario-' + beneficiario.id;
                linha.innerHTML = 
                    '<td>' + cpfFormatado + '</td>' +
                    '<td>' + beneficiario.nome + '</td>' +
                    '<td>' +
                        '<button type="button" class="btn btn-primary btn-xs" onclick="alterarBeneficiario(' + beneficiario.id + ')" title="Alterar beneficiário">Alterar</button> ' +
                        '<button type="button" class="btn btn-danger btn-xs" onclick="excluirBeneficiario(' + beneficiario.id + ')" title="Excluir beneficiário" style="margin-left: 5px;">Excluir</button>' +
                    '</td>';
                
                tbody.appendChild(linha);
            }
        }
    }

    function alterarBeneficiario(id) {
        for (var i = 0; i < beneficiarios.length; i++) {
            if (beneficiarios[i].id === id) {
                var beneficiario = beneficiarios[i];
                
                var cpfInput = document.getElementById('modalCPFBeneficiario');
                var nomeInput = document.getElementById('modalNomeBeneficiario');
                
                if (cpfInput) cpfInput.value = beneficiario.cpf;
                if (nomeInput) nomeInput.value = beneficiario.nome;
                
                beneficiarios.splice(i, 1);
                atualizarTabelaBeneficiarios();
                
                if (cpfInput) cpfInput.focus();
                break;
            }
        }
    }

    function excluirBeneficiario(id) {
        for (var i = 0; i < beneficiarios.length; i++) {
            if (beneficiarios[i].id === id) {
                var beneficiario = beneficiarios[i];
                
                if (confirm('Tem certeza que deseja excluir o beneficiário ' + beneficiario.nome + '?')) {
                    beneficiarios.splice(i, 1);
                    atualizarTabelaBeneficiarios();
                }
                break;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var cpfInput = document.getElementById('modalCPFBeneficiario');
        if (cpfInput) {
            cpfInput.addEventListener('input', function(e) {
                e.target.value = mascaraCPFBeneficiario(e.target.value);
            });
        }
        
        var btnIncluir = document.getElementById('btnIncluirBeneficiario');
        if (btnIncluir) {
            btnIncluir.addEventListener('click', function() {
                incluirBeneficiario();
            });
        }

        var btnCancelar = document.getElementById('btnCancelarBeneficiario');
        if (btnCancelar) {
            btnCancelar.addEventListener('click', function() {
                limparFormularioBeneficiario();
            });
        }

        if (cpfInput) {
            cpfInput.addEventListener('keypress', function(e) {
                if (e.which === 13 || e.keyCode === 13) {
                    incluirBeneficiario();
                }
            });
        }
        
        var nomeInput = document.getElementById('modalNomeBeneficiario');
        if (nomeInput) {
            nomeInput.addEventListener('keypress', function(e) {
                if (e.which === 13 || e.keyCode === 13) {
                    incluirBeneficiario();
                }
            });
        }

        atualizarTabelaBeneficiarios();
    });

    function alterarBeneficiario(id) {
        var beneficiario = beneficiarios.find(b => b.id === id);
        if (beneficiario) {
            var cpfInput = document.getElementById('modalCPFBeneficiario');
            var nomeInput = document.getElementById('modalNomeBeneficiario');
            var btnIncluir = document.getElementById('btnIncluirBeneficiario');
            var btnCancelar = document.getElementById('btnCancelarBeneficiario');
            
            if (cpfInput) cpfInput.value = beneficiario.cpf;
            if (nomeInput) nomeInput.value = beneficiario.nome;
            
           
            if (btnIncluir) {
                btnIncluir.textContent = 'Salvar';
                btnIncluir.className = 'btn btn-warning btn-sm';
                btnIncluir.setAttribute('data-editing-id', id);
            }
            
        
            if (btnCancelar) {
                btnCancelar.style.display = 'inline-block';
            }
            
            if (cpfInput) cpfInput.focus();
        }
    }

    function excluirBeneficiario(id) {
        if (confirm('Tem certeza que deseja excluir este beneficiário?')) {
            beneficiarios = beneficiarios.filter(b => b.id !== id);
            window.beneficiarios = beneficiarios;
            atualizarTabelaBeneficiarios();
        }
    }

    function limparFormularioBeneficiario() {
        var cpfInput = document.getElementById('modalCPFBeneficiario');
        var nomeInput = document.getElementById('modalNomeBeneficiario');
        var btnIncluir = document.getElementById('btnIncluirBeneficiario');
        var btnCancelar = document.getElementById('btnCancelarBeneficiario');
        
        if (cpfInput) cpfInput.value = '';
        if (nomeInput) nomeInput.value = '';
        
        if (btnIncluir) {
            btnIncluir.textContent = 'Incluir';
            btnIncluir.className = 'btn btn-success btn-sm';
            btnIncluir.removeAttribute('data-editing-id');
        }
        
        if (btnCancelar) {
            btnCancelar.style.display = 'none';
        }
        
        if (cpfInput) cpfInput.focus();
    }

    function aguardarJQuery() {
        if (typeof jQuery !== 'undefined') {
            jQuery('#modalBeneficiario').on('shown.bs.modal', function() {
                carregarBeneficiariosExistentes();
                var cpfInput = document.getElementById('modalCPFBeneficiario');
                if (cpfInput) cpfInput.focus();
            });
        } else {
            setTimeout(aguardarJQuery, 100);
        }
    }

    function carregarBeneficiariosExistentes() {
        
        if (typeof obj !== 'undefined' && obj && obj.Id) {
            $.ajax({
                url: '@Url.Action("BuscarBeneficiarios", "Cliente")',
                method: "GET",
                data: { clienteId: obj.Id },
                success: function(data) {
                    if (data && !data.erro) {
                        
                        beneficiarios = [];
                        
                        
                        for (var i = 0; i < data.length; i++) {
                            var cpfFormatado = mascaraCPFBeneficiario(data[i].CPF);
                            beneficiarios.push({
                                id: contadorBeneficiarios++,
                                cpf: cpfFormatado,
                                cpfLimpo: data[i].CPF.replace(/\D/g, ""),
                                nome: data[i].Nome
                            });
                        }
                        
                        // Atualizar a tabela
                        atualizarTabelaBeneficiarios();
                    }
                },
                error: function() {
                    console.log('Erro ao carregar beneficiários existentes');
                    atualizarTabelaBeneficiarios();
                }
            });
        } else {
            atualizarTabelaBeneficiarios();
        }
    }
    
    setTimeout(aguardarJQuery, 100);
</script>
